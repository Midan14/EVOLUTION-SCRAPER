#!/usr/bin/env bash
# Script para verificar el estado del servidor cuando SSH no funciona

SERVER="165.227.69.58"

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘     DIAGNÃ“STICO DEL SERVIDOR - NO HAY ACCESO SSH          â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

echo "ğŸ” Servidor: $SERVER"
echo ""

# 1. Verificar si el servidor estÃ¡ UP (ping)
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "1ï¸âƒ£  VERIFICANDO SI EL SERVIDOR ESTÃ ENCENDIDO (PING)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if ping -c 3 -W 5 $SERVER > /dev/null 2>&1; then
    echo "âœ… El servidor responde a PING - estÃ¡ ENCENDIDO"
else
    echo "âŒ El servidor NO responde a PING"
    echo "   Posibles causas:"
    echo "   - El servidor estÃ¡ apagado en DigitalOcean"
    echo "   - Problema de red"
    echo ""
    echo "ğŸ‘‰ SOLUCIÃ“N: Entra al panel de DigitalOcean y verifica que el droplet estÃ© encendido"
fi
echo ""

# 2. Verificar puerto SSH (22)
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "2ï¸âƒ£  VERIFICANDO PUERTO SSH (22)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if nc -z -w 5 $SERVER 22 2>/dev/null; then
    echo "âœ… Puerto SSH (22) estÃ¡ ABIERTO pero la autenticaciÃ³n falla"
    echo "   Posibles causas:"
    echo "   - CambiÃ³ la clave SSH"
    echo "   - CambiÃ³ la configuraciÃ³n del servidor"
else
    echo "âŒ Puerto SSH (22) estÃ¡ CERRADO o bloqueado"
    echo "   Posibles causas:"
    echo "   - El firewall estÃ¡ bloqueando el puerto"
    echo "   - La VPN estÃ¡ interfiriendo con SSH"
    echo "   - El servicio SSH estÃ¡ caÃ­do"
fi
echo ""

# 3. InformaciÃ³n para el usuario
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "3ï¸âƒ£  SOLUCIONES DISPONIBLES"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ“Œ OPCIÃ“N A: Usar la Consola Web de DigitalOcean"
echo "   1. Ve a: https://cloud.digitalocean.com/"
echo "   2. Busca tu droplet (IP: $SERVER)"
echo "   3. Haz clic en 'Console' o 'Access Console'"
echo "   4. Una vez dentro, ejecuta:"
echo ""
echo "      # Ver estado del bot"
echo "      systemctl status dragonbot"
echo ""
echo "      # Ver logs recientes"
echo "      journalctl -u dragonbot -n 50"
echo ""
echo "      # Ver logs en tiempo real"
echo "      journalctl -u dragonbot -f"
echo ""
echo "      # Reiniciar el bot"
echo "      systemctl restart dragonbot"
echo ""
echo "      # Ver IP actual (para verificar VPN)"
echo "      curl ifconfig.me"
echo ""
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""
echo "ğŸ“Œ OPCIÃ“N B: Verificar en el Panel de DigitalOcean"
echo "   1. Ve a: https://cloud.digitalocean.com/"
echo "   2. Verifica que el droplet estÃ© 'ON' (encendido)"
echo "   3. Revisa grÃ¡ficas de CPU/Memoria"
echo "   4. Revisa si hay alertas del sistema"
echo ""
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""
echo "ğŸ“Œ OPCIÃ“N C: Reiniciar el droplet desde el panel"
echo "   1. Ve a: https://cloud.digitalocean.com/"
echo "   2. Encuentra tu droplet"
echo "   3. Haz clic en 'Power' â†’ 'Reboot'"
echo "   4. Espera 2-3 minutos y prueba de nuevo la conexiÃ³n SSH"
echo ""
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""
echo "ğŸ“Œ OPCIÃ“N D: Verificar el bot via Telegram"
echo "   - El bot debe estar enviando mensajes a Telegram"
echo "   - Revisa tu chat de Telegram con el bot"
echo "   - Si hay mensajes recientes, el bot estÃ¡ funcionando"
echo "   - Si no hay mensajes, el bot puede estar caÃ­do"
echo ""
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""
echo "âš ï¸  NOTAS IMPORTANTES:"
echo "   - La VPN puede estar bloqueando el puerto SSH"
echo "   - Si el bot funciona (envÃ­a mensajes a Telegram), NO es urgente el SSH"
echo "   - Puedes usar la consola web de DigitalOcean en lugar de SSH"
echo ""
